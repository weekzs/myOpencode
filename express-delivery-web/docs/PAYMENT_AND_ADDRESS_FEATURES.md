# 微信支付和地址历史记录功能说明

## 已实现功能

### 1. 地址历史记录选择功能

#### 功能特点：
- ✅ 用户可以从历史地址中选择，快速填写订单信息
- ✅ 自动加载用户的地址历史记录
- ✅ 如果有默认地址，自动填充到表单
- ✅ 选择历史地址后，自动填充收件人姓名、电话和地址信息
- ✅ 新选择的地址会自动保存到历史记录（避免重复保存）
- ✅ 显示地址数量提示

#### 实现位置：
- **组件**: `frontend/src/components/ui/AddressSelector.tsx` - 地址选择器组件
- **页面**: `frontend/src/app/order/page.tsx` - 订单创建页面

#### 使用方法：
1. 在订单创建页面，点击"历史地址"按钮
2. 从弹出的地址列表中选择一个地址
3. 地址信息会自动填充到表单中

### 2. 微信支付功能完善

#### 功能特点：
- ✅ 支持微信内环境（使用微信JS-SDK）
- ✅ 支持非微信环境（模拟支付，用于测试）
- ✅ 支付状态自动轮询（最多30秒）
- ✅ 支付成功后自动刷新页面
- ✅ 支付失败或取消时给出友好提示
- ✅ 改进的支付回调处理逻辑

#### 实现位置：
- **页面**: `frontend/src/app/orders/[id]/page.tsx` - 订单详情页面
- **服务**: `backend/src/services/wechatPayService.ts` - 微信支付服务

#### 支付流程：
1. 用户点击"立即支付"按钮
2. 系统创建支付订单并获取微信支付参数
3. 在微信环境中调用微信支付SDK
4. 支付成功后，系统自动轮询支付状态
5. 支付状态更新后，自动刷新页面显示最新状态

#### 支付状态轮询：
- 每1秒查询一次支付状态
- 最多轮询30次（约30秒）
- 支付成功后立即停止轮询并刷新页面

### 3. 地址自动保存功能

#### 功能特点：
- ✅ 用户选择地址后，自动保存到历史记录
- ✅ 避免重复保存相同地址（通过经纬度判断）
- ✅ 智能解析地址信息（省市区）
- ✅ 第一个地址自动设为默认地址

#### 实现逻辑：
- 当用户在地图上选择地址时，系统会检查该地址是否已存在
- 如果不存在，则自动创建新的地址记录
- 地址信息包括：省、市、区、详细地址、经纬度

## 技术实现细节

### 地址选择器组件
- 使用模态框显示地址列表
- 支持选择地址并自动关闭
- 显示默认地址标识
- 响应式设计，适配移动端

### 微信支付集成
- 检测微信环境（通过User-Agent和wx对象）
- 自动加载微信JS-SDK（如果未加载）
- 支持支付成功、失败、取消三种状态
- 支付状态轮询机制

### 地址保存逻辑
- 通过经纬度判断地址是否重复（允许0.001度的误差）
- 智能解析地址字符串，提取省市区信息
- 如果解析失败，使用默认值

## 使用说明

### 对于用户：
1. **选择历史地址**：
   - 在订单创建页面，点击"历史地址"按钮
   - 从列表中选择一个地址
   - 地址信息会自动填充

2. **支付订单**：
   - 在订单详情页面，点击"立即支付"按钮
   - 在微信中会调起微信支付
   - 支付完成后，页面会自动刷新显示最新状态

### 对于开发者：
1. **测试支付功能**：
   - 在非微信环境中，系统会提示使用模拟支付
   - 可以用于开发和测试

2. **配置微信支付**：
   - 需要在后端`.env`文件中配置微信支付相关参数
   - 包括：AppID、商户号、API密钥等

## 注意事项

1. **地址保存**：
   - 只有在用户已登录的情况下才会保存地址
   - 需要填写收件人姓名和电话才能保存地址

2. **支付环境**：
   - 微信支付需要在微信环境中使用
   - 非微信环境可以使用模拟支付进行测试

3. **支付回调**：
   - 支付回调URL需要在微信支付平台配置
   - 回调URL格式：`http://your-domain.com/api/payments/notify`

## 后续优化建议

1. 添加地址编辑和删除功能
2. 支持地址搜索和筛选
3. 添加支付二维码生成（用于非微信环境）
4. 优化地址解析准确性（使用地理编码API）
5. 添加支付超时处理
6. 支持多种支付方式（支付宝等）
